## Legacy C refactoring

### Environment
- OS: Debian 12 and ARM MacOS
- gcc 12.2.0
- clang 21.1.0
- clang-tidy 14.0.6
- GNU Make 4.3

**Install packages**

* x86_64 Debian Linux
```bash
$ sudo apt update
$ sudo apt install -y build-essential clang clang-tidy cppcheck valgrind doxygen splint git make
$ sudo apt install -y clang-format indent pandoc texlive-latex-base ed
```

* ARM MacOS
```bash
# valgrind: Linux is required for this software.
$ brew install cppcheck splint doxygen
```

Install `lizard`

```bash
$ git clone git@github.com:terryyin/lizard.git
$ cd lizard
$ git checkout 1.17.31
$ sudo python3 setup.py install
$ which lizard
/usr/local/bin/lizard
```

### Heirloom Project
Download source code from the [sourceforge](https://sourceforge.net/projects/heirloom/)

```bash
$ wget https://sourceforge.net/projects/heirloom/files/heirloom/070715/heirloom-070715.tar.bz2
$ bzip2 -d heirloom-070715.tar.bz2
$ tar xvf heirloom-070715.tar
$ cd heirloom-070715
$ ls
```

### Build Heirloom subproject; grep
- Copy build/mk.config
- Copy libcommon and libuxre
```bash
$ cd heirloom-070715
$ make -f libcommon/Makefile.mk
$ make -f libuxre/Makefile.mk
$ make -f grep/Makefile.mk
```

### static analysis
- clang-tidy
- cppcheck
- splint

**grep/Makefile**
```make
LARGEF = -D_FILE_OFFSET_BITS=64L
IUXRE = -I../libuxre -DUXRE
ICOMMON = -I../libcommon
CFLAGSS = -Os -fomit-frame-pointer $(WARN)
CPPFLAGS = -D_GNU_SOURCE

grep.o: grep.c
	$(CC) $(CFLAGSS) $(CPPFLAGS) $(IWCHAR) $(ICOMMON) $(IUXRE) $(LARGEF) -c grep.c
```

**.clang-tidy example**
```
Checks: >
  bugprone-*,
  performance-*,
  modernize-*,
  readability-identifier-naming,
  readability-function-cognitive-complexity
WarningsAsErrors: ''
HeaderFilterRegex: '.*'
AnalyzeTemporaryDtors: false
FormatStyle: file
CheckOptions:
  - key:             readability-identifier-naming.VariableCase
    value:           lower_case
  - key:             readability-identifier-naming.FunctionCase
    value:           camelBack
  - key:             readability-function-cognitive-complexity.Threshold
    value:           '25'
```

Command
```bash
$ clang-tidy grep.c -system-headers -- -Os -fomit-frame-pointer -D_GNU_SOURCE -I../libcommon -I../libuxre -DUXRE -D_FILE_OFFSET_BITS=64L > clang-tidy.report.grep.c.txt
```